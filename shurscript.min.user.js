// Shur Scripts SA
// GPLv2 Licensed
// http://www.gnu.org/licenses/gpl-2.0.html
//
// ==UserScript==
// @name            ShurScript
// @description     Script para ForoCoches
// @namespace       http://shurscript.es
// @version         0.20.1-exp
// @author          TheBronx
// @author          xusoO
// @author          Fritanga
// @author          juno / ikaros45
// @include         *forocoches.com*
// @grant           GM_log
// @grant           GM_getValue
// @grant           GM_setValue
// @grant           GM_deleteValue
// @grant           GM_xmlhttpRequest
// @grant           GM_registerMenuCommand
// @grant           GM_addStyle
// @grant           GM_getResourceText
// @grant           GM_getResourceURL
// @grant           GM_getMetadata
// @run-at          document-end
// @require         http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js
// @require         http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js
// @require         http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js
// @require         https://github.com/TheBronx/shurscript/raw/dev/plugins/bootbox.js
// @require         https://github.com/TheBronx/shurscript/raw/dev/plugins/Markdown.Converter.js
// @resource        bootstrapcss https://github.com/TheBronx/shurscript/raw/dev/css/bootstrap.css
// @resource        modalcss https://github.com/TheBronx/shurscript/raw/dev/css/modal.css
// @resource        modalhtml https://github.com/TheBronx/shurscript/raw/dev/html/modal.html
// @resource        quotehtml https://github.com/TheBronx/shurscript/raw/dev/html/quote.html
// @resource        imageuploadercss https://github.com/TheBronx/shurscript/raw/experimental/css/imageuploader.css
// @resource        imageuploaderhtml https://github.com/TheBronx/shurscript/raw/experimental/html/imageuploader.html
// ==/UserScript==
var SHURSCRIPT={GreaseMonkey:{log:GM_log,getValue:GM_getValue,setValue:GM_setValue,deleteValue:GM_deleteValue,xmlhttpRequest:GM_xmlhttpRequest,registerMenuCommand:GM_registerMenuCommand,addStyle:GM_addStyle,getResourceText:GM_getResourceText,getResourceURL:GM_getResourceURL},config:{server:"http://cloud.shurscript.org:8080/"},environment:{page:-1!=location.pathname.indexOf("/foro")?location.pathname.replace("/foro",""):"frontpage"}};(function(e,t,o,a,n,r){"use strict";var i={},s=o.GreaseMonkey;o.core=i;var l=function(){var e;if("undefined"!=typeof GM_info)e=GM_info.script.version;else{if("undefined"==typeof GM_getMetadata)return!1;e=GM_getMetadata("version")+""}var t=e.split("-");return o.scriptVersion=t[0],o.scriptBranch=t[1]||"master",!0},d={__init__:function(e){return this.moduleId=e,delete this.__init__,this},log:function(t){n.log(this._getCallerDescription()+t);var o=e("#shurscript_log");0===o.length&&(e(document.body).append('<div id="shurscript_log" style="display:none;"></div>'),o=e("#shurscript_log")),o.append(t+"<br>")},_getShurKey:function(e,t){var a=t===!0?"_"+o.environment.user.id:"";return"SHURSCRIPT_"+this.moduleId+"_"+e+a},_getCallerDescription:function(){return"[SHURSCRIPT]  [Modulo "+this.moduleId+"] "+(new Date).toLocaleTimeString()+": "},setValue:function(e,t,o){s.setValue(this._getShurKey(e,!1),t,o)},getValue:function(e,t){return s.getValue(this._getShurKey(e,!1),t)},deleteValue:function(e,t){s.deleteValue(this._getShurKey(e,!1),t)},setLocalValue:function(e,t){GM_setValue(this._getShurKey(e,!0),t)},getLocalValue:function(e,t){return GM_getValue(this._getShurKey(e,!0),t)},deleteLocalValue:function(e){GM_deleteValue(this._getShurKey(e,!0))},"throw":function(e,t){this.log("[EXCEPTION] - "+e),t!==r&&(this.log(t),n.log(t))},addStyle:function(e){var t=s.getResourceText(e);s.addStyle(t)},showMessageBar:function(e){o.topbar.showMessage(e)},getResourceText:s.getResourceText,getResourceURL:s.getResourceURL,bootbox:a,location:location},c=function(){var e=Object.create(d);return e.createPreferenceOption=o.preferences.createOption,e.templater=o.templater,e.environment=o.environment,e};i.createComponentHelper=function(e){return Object.create(d).__init__(e)},i.createModuleHelper=function(e){return c().__init__(e)},i.helper=i.createComponentHelper("core"),i.createComponent=function(e){e===r&&i.helper.throw("Error al crear componente. El ID no ha sido definido.");var t={id:e};return o[e]=t,i.components===r&&(i.components=[]),i.components.push(e),t.helper=i.createComponentHelper(t.id),t},i.initialize=function(){if(!l())return alert("SHURSCRIPT: El complemento o extensión de userscripts que usas en tu navegador no está soportado."),r;var a=e("body").html(),n=/userid=(\d*)/.exec(a);if(n){var s;s="frontpage"===o.environment.page?e(".cajascat td.cat:nth-child(1)").text().substr(3):/Hola, <(?:.*?)>(\w*)<\/(?:.*?)>/.exec(a)[1],o.environment.user={id:n[1],name:s},o.environment.browser={name:navigator.userAgent},i.helper.addStyle("bootstrapcss"),i.helper.bootbox.setDefaults({locale:"es",className:"shurscript",closeButton:!1}),e.ajax({type:"GET",url:o.config.server+"config-"+o.scriptBranch}).done(function(e){t.extend(o.config,e),i.loadNextComponent(),i.helper.deleteLocalValue("SERVER_DOWN_ALERT")}).fail(function(){i.helper.getLocalValue("SERVER_DOWN_ALERT")||setTimeout(function(){i.helper.showMessageBar({message:"<strong>Oops...</strong> Parece que se ha roto alguna pieza en el servidor de <strong>Shurscript</strong>. Int&eacute;ntalo de nuevo en unos minutos o deja constancia en el <a href='http://shurscript.org/hilo'>hilo oficial</a>.",type:"danger",onClose:function(){i.helper.setLocalValue("SERVER_DOWN_ALERT",!0)}})},2e3)})}},i.loadNextComponent=function(){var e=i.getNextComponent();return e===r?(o.moduleManager.startOnDocReadyModules(),r):t.isFunction(e.loadAndCallback)?(i.helper.log("Cargando componente "+e.id),e.loadAndCallback(i.loadNextComponent),r):(t.isFunction(e.load)&&e.load(),i.loadNextComponent(),r)},i.getNextComponent=function(){return i.components!==r?(i.componentIndex===r?i.componentIndex=0:i.componentIndex+=1,o[i.components[i.componentIndex]]):r},i.initializeEagerly=function(){o.moduleManager.startEagerModules()}})(jQuery,_,SHURSCRIPT,bootbox,console),function(e,t){"use strict";function o(e){"string"==typeof e&&(e={message:e}),e.type=e.type||"info"}var a,n=t.core.createComponent("topbar");n.showMessage=function(t){o(t),a||(e('<div class="shurscript">').prependTo(e("body")).append(a=e('<div style="padding: 10px; text-align: center;"><span class="message"/><button type="button" class="close" style="position: absolute; right: 15px; line-height: 15px">&times;</button></div>')),a.hide()),a.find(".message").html(t.message),a.attr("class","alert alert-"+t.type),a.slideDown(),a.on("click",".close",function(){a.slideUp(),t.onClose&&t.onClose()})}}(jQuery,SHURSCRIPT),function(e,t,o){"use strict";function a(){var t=r.helper.getLocalValue("API_KEY");if(!t){var o=new XMLHttpRequest;o.open("GET","http://www.forocoches.com/foro/subscription.php?do=editfolders",!1),o.onreadystatechange=function(){if(4==o.readyState&&"OK"==o.statusText){var a=e.parseHTML(o.responseText),n=e(a).find("input[name='folderlist[50]']");n.length>0&&(t=n.val().replace("shurkey-",""),r.helper.setLocalValue("API_KEY",t))}},o.send()}return t}function n(t){var o=new XMLHttpRequest;o.open("POST","http://www.forocoches.com/foro/subscription.php?do=doeditfolders",!1),o.onreadystatechange=function(){4==o.readyState&&"OK"==o.statusText&&0==a()&&n(t)};var r="shurkey-"+t,i=e("input[name='securitytoken']").val(),s="s=&securitytoken="+i+"&do=doeditfolders&folderlist[50]="+r+"&do=doeditfolders";o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.setRequestHeader("Content-length",s.length),o.setRequestHeader("Connection","close"),o.send(s)}var r=t.core.createComponent("sync");({setValue:t.GreaseMonkey.setValue,getValue:t.GreaseMonkey.getValue,deleteValue:t.GreaseMonkey.deleteValue});var i={server:t.config.server,apiKey:"",preferences:{},setValue:function(t,o,a){e.ajax({type:"PUT",url:this.server+"preferences/"+t+"/?apikey="+this.apiKey,data:{value:o},dataType:"json"}).done(a)},getValue:function(t,o){e.ajax({type:"get",url:this.server+"preferences/"+t+"/?apikey="+this.apiKey,data:"",dataType:"json"}).done(o)},getAll:function(o){t.config.apiKey=this.apiKey,r.helper.log("Cloud.getAll() using API key: "+this.apiKey),e.ajax({type:"get",url:this.server+"preferences/?apikey="+this.apiKey,data:"",dataType:"json"}).done(function(e){i.preferences=e,o()}).fail(function(e){switch(e.status){case 403:bootbox.confirm("<h3>¡Un momento!</h3>La Shurkey que estás utilizando no es válida ¿Quieres que te generemos una nueva?",function(e){e&&i.generateApiKey(function(){i.getAll(o)})});break;case 500:default:r.helper.showMessageBar({message:"<strong>Oops...</strong> Parece que hay tormenta en el cloud de Shurscript... Prueba de nuevo en unos instantes o deja constancia en el <a href='"+t.config.fcThread+"'>hilo oficial</a>.",type:"danger"})}r.helper.throw("Error al recuperar las preferencias",e)})},deleteValue:function(e,t){this.setValue(e,"",t)},generateApiKey:function(t){r.helper.deleteLocalValue("API_KEY"),r.helper.log("Cloud.generateApiKey()"),e.ajax({type:"POST",url:this.server+"preferences/",data:"",dataType:"json"}).done(function(e){r.helper.log("Generated API Key:"+JSON.stringify(e)),i.apiKey=e.apikey,n(i.apiKey),t()})}};r.loadAndCallback=function(e){t.GreaseMonkey.setValue=function(e,t,o){i.preferences[e]=t,i.setValue(e,t,o)},t.GreaseMonkey.getValue=function(e,t){return i.preferences[e]!=o?i.preferences[e]:t},t.GreaseMonkey.deleteValue=function(e,t){i.deleteValue(e,t)};var n=a();n?(i.apiKey=n,i.getAll(e)):i.generateApiKey(function(){i.getAll(e)})},r.generateApiKey=function(e){i.generateApiKey(e)}}(jQuery,SHURSCRIPT),function(e,t,o){"use strict";var a=t.core.createComponent("moduleManager");a.ALL="ALL",a.NO_FRONTPAGE="NO_FRONTPAGE";var n={__init__:function(n){var r=["id","name","author","version","description"],i=this;return e.each(r,function(e,t){if(n[t]===o){var r=n.id||n.name||"no identificado",s="Error generando modulo {"+r+"}.El parametro "+t+" no ha sido definido.";a.helper.log(s),a.helper.throw(s)}i[t]=n[t]}),this.initialPreferences=n.initialPreferences||{},this.preferences={enabled:!0},n.domain!==o&&(this.domain=n.domain),this.helper=t.core.createModuleHelper(n.id),a.modules[this.id]=this,delete this.__init__,this},preferences:{enabled:!0},storePreferences:function(e){var t=JSON.stringify(this.preferences);this.helper.setValue("__preferences",t,e)},refreshPreferences:function(){var t=this.helper.getValue("__preferences",""),o={};""!==t&&(o=JSON.parse(t)),e.extend(!0,this.preferences,this.initialPreferences,o)},migratePreferences:function(e){for(var t in this.preferences){for(var a="",n=0;t.length>n;n++)t[n]==t[n].toUpperCase()&&(a+="_"),a+=t[n].toUpperCase();var r=this.helper.getLocalValue(a);r!==o&&(this.preferences[t]=r,this.helper.log("Migrada: "+a+" = "+r))}this.storePreferences(e)},migrateValues:function(e){e&&e()},domain:a.NO_FRONTPAGE,getPreferenceOptions:function(){return[]},eagerStartCheck:function(){return!1},onEagerStart:function(){},isValidPage:function(){var e=this.domain,o=t.environment.page;return"string"==typeof e?e===a.ALL?!0:e===a.NO_FRONTPAGE?"/"!==o:o===e:e.indexOf(o)>-1},normalStartCheck:function(){return!0},onNormalStart:function(){}};a.modules={},a.createModule=function(e){try{return Object.create(n).__init__(e)}catch(t){mod.helper.throw("Error creando módulo:",t)}},a.migratePreferences=function(o){bootbox.dialog({message:"<center>Migrando preferencias...</center>"});var n=0,r=0,i=function(){n++,n==r&&a.helper.setValue("MIGRATION_DONE",!0,function(){o(),bootbox.hideAll()})},s=GM_getValue("SHURSCRIPT_MODULES_"+t.environment.user.id);s&&(s=JSON.parse(s),e.each(s,function(e,t){try{a.modules[e].preferences.enabled=t,a.helper.log("Migrando active status de "+e+": "+t)}catch(o){a.helper.throw("Error al migrar el active status de "+e,o)}})),e.each(a.modules,function(e,t){try{r++,t.migratePreferences(function(){t.migrateValues(i)})}catch(o){a.helper.throw("Error migrando las preferencias antiguas del modulo "+e,o)}})},a.startOnDocReadyModules=function(){return-1!=a.helper.location.hash.indexOf("newkey")&&a.helper.setValue("MIGRATION_DONE",!0),a.helper.getValue("MIGRATION_DONE")?(e.each(a.modules,function(e,t){try{if(t.refreshPreferences(),!t.preferences.enabled)return!0;if(!t.isValidPage())return!0;if(!t.normalStartCheck())return!0;a.helper.log("Cargando modulo "+t.id),t.onNormalStart(),a.helper.log("Modulo "+t.id+" cargado")}catch(o){a.helper.log("Fallo cargando modulo "+t.id+"\nRazon: "+o)}}),o):(a.migratePreferences(function(){a.startOnDocReadyModules()}),o)},a.startEagerModules=function(){e.each(a.modules,function(e,t){try{if(t.refreshPreferences(),!t.preferences.enabled)return!0;if(!t.eagerStartCheck())return!0;if(!t.isValidPage())return!0;a.helper.log("[Modo prematuro] Cargando modulo "+t.id),t.onEagerStart(),a.helper.log("[Modo prematuro] Modulo "+t.id+" cargado")}catch(o){a.helper.log("[Modo prematuro] Fallo cargando modulo "+t.id+"\nRazon: "+o)}})}}(jQuery,SHURSCRIPT),function(e,t){"use strict";var o=t.core.createComponent("templater"),a={};o.storeTemplate=function(e,t){a[e]={tempName:e,tempText:t,compiled:!1}},o.fillOut=function(e,t){var n=a[e];n.compiled||o.compile(e);try{return a[e].tempFn(t)}catch(r){o.helper.throw("Error insertando valores en la plantilla:",r)}},o.compile=function(e){var t=a[e];if(!t.compiled)try{t.tempFn=Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+t.tempText.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"),t.compiled=!0}catch(n){o.helper.throw("Error compilando template ["+e+"]: ",n)}}}(jQuery,SHURSCRIPT),function(e,t){"use strict";function o(e){t.GreaseMonkey.xmlhttpRequest({method:"GET",url:t.config.updateURL,onload:function(t){var o=/\/\/\s*@version\s+(.+)\s*\n/i.exec(t.responseText)[1],n=o.split("-")[1];o=o.split("-")[0];var r=a(o,n);e(r,o)}})}function a(e,o){var a,n=t.scriptVersion,r=t.scriptBranch;return a="exp"==r&&"dev"==o||"dev"==r&&!o?e>=n:e>n}function n(e){s.getChangelog(function(o){bootbox.dialog({message:"<h4>Hay disponible una nueva versión ("+e+") del Shurscript.</h4><p><br></p>"+o,buttons:[{label:"Más tarde",className:"btn-default"},{label:"Actualizar",className:"btn-primary",callback:function(){bootbox.hideAll(),location.href=t.config.installURL}}]})},e)}function r(e,t){return t=t.replace(/\./g,"\\."),e=e.match(RegExp("##[#]? v"+t+"[ \n].*([\\s\\S]*?(?=---))"))[1].trim(),e=(new Markdown.Converter).makeHtml(e)}var i,s=t.core.createComponent("autoupdater"),l=36e5;s.check=function(e,t){i=(new Date).getTime();var a=parseInt(s.helper.getLocalValue("LAST_SCRIPT_UPDATE",0),10);(e||i>a+l)&&(s.helper.setLocalValue("LAST_SCRIPT_UPDATE",""+i),o(function(e,o){e&&n(o),"function"==typeof t&&t(e)}))},s.load=function(){s.check(!1)},s.getChangelog=function(e,o){t.GreaseMonkey.xmlhttpRequest({method:"GET",url:t.config.rawChangelog+"?"+i,onload:function(a){var n;try{n=r(a.responseText,o||t.scriptVersion)}catch(i){n="Haz clic <a target='_blank' href='"+t.config.visualChangelog+"'>aquí</a> para ver los cambios de esta versión."}e(n)}})}}(jQuery,SHURSCRIPT),function(e,t,o){"use strict";var a=t.core.createComponent("preferences");a.appendMenuItem=function(){var t=e(".vbmenu_control").first(),o=t.clone();o.css("cursor","pointer"),o.html("<a>Shurscript</a>"),t.parent().append(o),o.click(a.onShow)},a.onShow=function(){var o=a.createModal();e("body").append(o),o.on("hidden.bs.modal",function(){o.remove()}),o.on("click","#check-shurscript-updates",function(){a.checkUpdates()}),o.on("click",".shur-btn-options",function(){e(this).parent().siblings(".shur-options-body").slideToggle(300)}),o.on("click","#save-settings",function(){a.saveSettings()}),o.on("change","input",function(){e(this).parents(".shur-module-preferences").addClass("changed")}),o.on("click",".shur-module-enabled",function(){var t=e(this).parents(".shur-module-preferences");t.toggleClass("disabled-module"),t.children(".panel-body").slideToggle(),t.addClass("changed")}),o.modal(),o.css("z-index",1e3),e(".modal-backdrop").css("z-index",999),e(window).on("resize",function(){o.find(".modal-body").css("height",e(window).height()-280)}),e(window).trigger("resize"),o.find('a[data-toggle="tab"][href="#tab-about"]').on("shown.bs.tab",function(){t.autoupdater.getChangelog(function(e){o.find("#shur-changelog .panel-body").html(e)}),e(this).off("shown.bs.tab")}),o.on("click","#change-api-key",function(){bootbox.confirm("Recuerde que generar una nueva API Key elimina todos sus datos y configuraciones. Pulse en Aceptar para continuar con el proceso.",function(e){e&&(bootbox.hideAll(),bootbox.dialog({message:"<center>Generando API Key...</center>"}),t.sync.generateApiKey(function(){a.helper.location.href="#newkey",a.helper.location.reload()}))})}),o.find('a[data-toggle="tab"][href="#tab-debug"]').on("shown.bs.tab",function(){e("#debug-log").html(e("#shurscript_log").html())}),o.on("click","#debug-send",function(){bootbox.confirm("Por el bien de la comunidad, no abuse de esta utilidad y <strong>trate de ser todo lo conciso posible</strong> para ayudar a resolver el problema. Confirme que desea enviar el registro de shurscript y el suceso que ha escrito.",function(t){t&&(e.post("http://shurscript.org/report.php",e("#debug-form").serialize()),e("#debug-send").attr({disabled:"disabled",value:"Reporte enviado correctamente"}))})}),a.$modal=o},a.checkUpdates=function(){var o=e("#check-shurscript-updates");o.button("loading"),t.autoupdater.check(!0,function(e){o.button("reset"),e||bootbox.alert("No hay actualizaciones disponibles del Shurscript")})},a.saveSettings=function(){var o=0,n=a.$modal.find(".shur-module-preferences.changed");n.length?(bootbox.dialog({message:"<center>Guardando cambios...</center>"}),n.each(function(r,i){var s=e(i),l=s.data("module-id"),d=t.moduleManager.modules[l],c=d.preferences;c.enabled=s.find(".shur-module-enabled").is(":checked"),s.find(".shur-option").each(function(t,o){var a,n,r,i=e(o);i.hasClass("shur-radio-group")?(a=i.find("input[type=radio]:checked"),n=a.val()):i.hasClass("shur-checkbox-group")?(a=i.find("input"),n=a.is(":checked")):i.hasClass("shur-text-group")&&(a=i.find("input"),n=a.val()),r=a.data("maps-to"),c[r]=n}),d.storePreferences(function(){o++,o>=n.length&&a.helper.location.reload()})})):a.$modal.modal("hide")},a.createModal=function(){var o={scriptVersion:t.scriptVersion,scriptBranch:t.scriptBranch,apiKey:t.config.apiKey,visualChangelog:t.config.visualChangelog,userDebug:t.environment.user.name,urlDebug:t.preferences.helper.location.href,agentDebug:t.environment.browser.name,modules:[]};return e.each(t.moduleManager.modules,function(e,t){o.modules.push({id:t.id,name:t.name,description:t.description,options:t.getPreferenceOptions(),preferences:t.preferences})}),e(t.templater.fillOut("modal",o))},a.load=function(){a.appendMenuItem(),a.helper.addStyle("modalcss"),-1!=a.helper.location.hash.indexOf("newkey")&&(a.onShow(),a.$modal.find('a[data-toggle="tab"][href="#tab-about"]').tab("show"),setTimeout(function(){a.helper.location.href="#"},1e3))},a.createOption=function(t){var n=["checkbox","radio","text","color","header"],r=["type","caption"],i="Error creando opcion: ";return e.each(r,function(e,n){t[n]===o&&a.helper.throw(i+n+" no esta definido")}),-1===n.indexOf(t.type)&&a.helper.throw(i+type+" no es un tipo valido de opcion"),"radio"===t.type&&("[object Array]"!==Object.prototype.toString.call(t.elements)&&a.helper.throw(i+".elements no es un array"),e.each(t.elements,function(e,t){(t.value===o||t.caption===o)&&a.helper.throw(i+"Al elemento radio numero "+e+" le falta la propiedad value y/o caption"),t.subCaption=t.subCaption||""})),"header"!==t.type&&t.mapsTo===o&&a.helper.throw(i+".mapsTo no esta definido"),t.subCaption=t.subCaption||"",t},setTimeout(function(){var e="modal",o=a.helper.getResourceText("modalhtml");t.templater.storeTemplate(e,o),t.templater.compile(e)},0)}(jQuery,SHURSCRIPT),function(e,t){"use strict";function o(){"frontpage"===f.helper.environment.page?e("#AutoNumber1.contenido tr:first-child").append('<td style="padding: 0px;" rowspan=3 class="alt2"><div class="notifications">0</div></td>'):e(".page table td.alt2[nowrap]").first().parent().append('<td style="padding: 0px;" class="alt2"><div class="notifications">0</div></td>'),e(".notifications").click(function(){("ERROR"==E||!v||Date.now()-parseFloat(v)>6e4)&&a(),i()}),"off"!=g&&"/search.php"!=f.helper.environment.page&&(!v||Date.now()-parseFloat(v)>1e3*60*g)?a(!0):(s(x),E="OK")}function a(t){t=t!==undefined?t:!1,e(".notifications").html("..."),E="QUERY",b=new XMLHttpRequest,b.onreadystatechange=function(){if(4==b.readyState&&"OK"==b.statusText)try{v=Date.now();var o=e.parseHTML(b.responseText),r=e(o).find("#inlinemodform table[id*='post']");if(0==r.length){if(-1!=b.responseText.indexOf("debes estar registrado o identificado")){E="ERROR";var l=e(".notifications");return l.attr("title","Ha ocurrido un error al cargar las notificaciones. Contacta con los desarrolladores en el hilo oficial del Shurscript (ForoCoches)."),l.html("X"),undefined}var c=e(o).find(".page li").text();if(c&&!t){c=c.substring(c.indexOf("aún")+4);var m=c.substring(0,c.indexOf(" ")),g=parseInt(m)+1,w=setInterval(function(){g>0?n("...<sup>"+g--+"</sup>"):(a(),clearInterval(w))},1e3);return}if(t&&x.length>0)return s(x),E="OK",undefined}var T,S=Array();if(y)for(var R=0;r.length>R&&(T=new u(r[R],!1),y!=T.postLink);R++)(f.preferences.mentionsToo||h(T))&&S.push(T);r.length>0&&(y=new u(r[0]).postLink,f.helper.setValue("LAST_READ_QUOTE",y));var C=[],k=[];x=S.concat(x);for(var R=0;x.length>R;R++)x[R].read?k.push(x[R]):C.push(x[R]);x=C.concat(k.slice(0,10-C.length)),_=JSON.stringify(x),f.helper.setValue("LAST_QUOTES_UPDATE",""+Date.now()),f.helper.setValue("LAST_QUOTES",_),s(x),E="OK",f.preferences.showAlerts&&t&&(1==S.length?(T=S[0],bootbox.dialog({message:"El usuario <b>"+T.userName+"</b> te ha citado en el hilo <b>"+T.threadName+"</b><p><br></p><i>"+T.postText+"</i><p><br></p>¿Quieres ver el post ahora?",buttons:[{label:"Ya leída",className:"btn-default",callback:function(){p(T)}},{label:"Más tarde",className:"btn-default"},{label:"Abrir post",className:"btn-default",callback:function(){p(T,function(){window.open(T.postLink,"_self")})}},{label:"En nueva ventana",className:"btn-primary",callback:function(){p(T,function(){window.open(T.postLink,"_blank")})}}]})):S.length>1&&bootbox.dialog({message:"Tienes <b>"+S.length+" citas nuevas</b> en el foro ¿Quieres verlas ahora?",buttons:[{label:"Ya leídas",className:"btn-default",callback:function(){d()}},{label:"Más tarde",className:"btn-default"},{label:"Ver lista",className:"btn-default",callback:function(){e("html, body").animate({scrollTop:0},"slow"),i()}},{label:"Abrir todas en pestañas",className:"btn-primary",callback:function(){d(function(){S.forEach(function(e){window.open(e.postLink,"_blank")})})}}]}))}catch(M){f.helper.throw(M)}},b.open("GET",m,!0),b.send()}function n(t){var o=e(".notifications");t>0?(document.title="("+t+") - "+C,o.attr("title","Tienes "+t+" "+(1==t?"notificación no leída":"notificaciones no leídas")),o.addClass("unread")):(document.title=C,o.attr("title","No tienes ninguna notificación nueva"),o.removeClass("unread")),w=t,o.html(t)}function r(){T=e("<div id='notificationsBox'/>"),S=e("<div id='notificationsList'/>"),e(document.body).append(T),T.append(S),e(document).mouseup(function(e){"block"!=T.css("display")||T.is(e.target)||0!==T.has(e.target).length||(T.hide(),e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault())})}function i(){T.css("top",e(".notifications").offset().top+e(".notifications").height()+20),T.show()}function s(t){S.html('<div id="noNotificationsMessage">No tienes ninguna notificación</div>');for(var o=0,a=0;t.length>a;a++)c(t[a]),t[a].read||o++;if(n(o),!R){R=e("<table id='notificationsListButtons' border='0' cellspacing='0'><tr></tr></table>");var r=e("<td title='Marcar todas las citas como leídas'/>");if(r.html("Marcar como leídas"),r.click(function(){d()}),R.append(r),f.preferences.openInTabsButton){var i=e("<td title='Abrir todas las citas no leídas en diferentes pestañas'/>");i.html("Abrir en pestañas"),i.click(function(){var e=l();d(function(){e.forEach(function(e){window.open(e.postLink,"_blank")})})}),R.append(i)}T.append(R)}o>0?R.show():R.hide()}function l(){var e=[];return x.forEach(function(t){t.read||e.push(t)}),e}function d(e){for(var t=0;x.length>t;t++)x[t].read=!0;s(x),_=JSON.stringify(x),f.helper.setValue("LAST_QUOTES",_,e),T.hide()}function c(t){e("#noNotificationsMessage").hide();var o=e(SHURSCRIPT.templater.fillOut("quote",{cita:t}));o.on("mousedown",".postLink",function(o){3!=o.which&&(t.read?window.open(t.postLink,"_self"):(e(this).parent().parent().addClass("read"),p(t,function(){1==o.which&&window.open(t.postLink,"_self")})))}),S.append(o)}function p(e,t){e.read=!0,_=JSON.stringify(x),f.helper.setValue("LAST_QUOTES",_,t),n(w-1)}function u(t,o){var a=e(t).find(".smallfont > em > a");this.postLink=a.attr("href"),this.postText=a.text().replace(/</g,"&lt;"),this.postID=this.postLink.match(/#post([\d]*)/)[1];var n=e(t).find(".alt1 > div > a > strong");this.threadLink=n.parent().attr("href"),this.threadName=n.text();var r=e(t).find(".smallfont > a");this.userLink=r.attr("href"),this.userName=r.text(),this.read=o}function h(t){var o=!1;return b=new XMLHttpRequest,b.onreadystatechange=function(){if(4==b.readyState&&"OK"==b.statusText){var a=e.parseHTML(b.responseText),n=e(a).find("#post_message_"+t.postID).text(),r=f.helper.environment.user.name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");n.match(RegExp("Originalmente Escrito por "+r,"i"))&&(o=!0)}},b.open("GET",t.postLink,!1),b.send(),o}var f=t({id:"Quotes",name:"Notificador de citas y menciones",author:"xusoO",version:"0.2",description:"Avisará al usuario cada vez que alguien le cite en un post, mostrando alertas y un listado de las ultimas citas no leídas.",domain:"ALL",initialPreferences:{enabled:!0,showAlerts:!0,mentionsToo:!0,openInTabsButton:!1,refreshEvery:2}});f.getPreferenceOptions=function(){var e=f.helper.createPreferenceOption;return unsafeWindow.chromeTabsWarning=function(){bootbox.alert("<p>Si al darle al botón de Abrir en pestañas solo os abre una pestaña y no todas, es porque tenéis bloqueados los pop-ups para Forocoches, tendréis que permitirselos para poder abrir las notificaciones en pestañas.</p>				<p>Pero eso no es todo, Google Chrome por norma general solo te abrirá el primer enlace en una nueva pestaña. El resto te los abrirá en ventanas independientes.</p>				<p>Cómo sabemos que esto puede ser molesto y no existe solución por nuestra parte, en el caso que de verdad quieras usar esta funcionalidad de abrir las notificaciones en pestañas, 				deberás instalar <a target='_blank' href='https://chrome.google.com/webstore/detail/one-window/papnlnnbddhckngcblfljaelgceffobn/related'>esta extensión</a> que aunque no es una solución muy limpia, hace su función.</p>				<p>Para evitar confusiones, decir que esto no tiene nada que ver con abrir una única notificación en una nueva pestaña, eso funciona perfectamente. El problema descrito solo aplica cuando se abre más de una a la vez.</p> <p>Disculpa las molestias</p>")},[e({type:"checkbox",mapsTo:"showAlerts",caption:"Mostrar una alerta en el navegador cada vez que llegue una nueva notificación"}),e({type:"checkbox",mapsTo:"mentionsToo",caption:"Notificar también las menciones, no solo las citas",subCaption:"Si se desactiva puede ralentizar la recuperación de las notificaciones"}),e({type:"checkbox",mapsTo:"openInTabsButton",caption:"Mostrar botón en la lista de notificaciones para abrir las no leídas en pestañas. <b style='text-decoration:underline;' onclick='chromeTabsWarning()'>Leer usuarios de Chrome</b>"}),e({type:"radio",elements:[{value:2,caption:"Cada 2 minutos"},{value:10,caption:"Cada 10 minutos"},{value:30,caption:"Cada 30 minutos"},{value:"off",caption:"Manualmente",subCaption:"Haciendo clic en el contador de notificaciones"}],caption:"Buscar citas:",mapsTo:"refreshEvery"})]},GM_addStyle(".notifications {cursor: pointer; text-align: center; padding: 7px 15px; width: 40px; background: #CECECE; color: gray; font-size: 24pt;}"),GM_addStyle(".notifications.unread {background: #CC3300; color: white;}"),GM_addStyle(".notifications.unread:hover {background: #E64D1A; color: white;}"),GM_addStyle(".notifications sup {font-size: 10px;}"),GM_addStyle("#notificationsBox {background: #FFF;border: 1px solid #C30;position: absolute;display: none;box-shadow: 0 2px 4px -2px;right: 11px;font:10pt verdana,geneva,lucida,'lucida grande',arial,helvetica,sans-serif}"),GM_addStyle("#notificationsBox #notificationsList{overflow: auto;max-height: 380px;min-height: 83px;width: 340px;}"),GM_addStyle("#notificationsBox:after, #notificationsBox:before {bottom: 100%;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;pointer-events: none;}"),GM_addStyle("#notificationsBox:after {border-color: rgba(255, 255, 255, 0);border-bottom-color: #fff;border-width: 10px;left: 92%;margin-left: -10px;}"),GM_addStyle("#notificationsBox:before {border-color: rgba(204, 51, 0, 0);border-bottom-color: #CC3300;border-width: 11px;left: 92%;margin-left: -11px;}"),GM_addStyle(".notificationRow {overflow: visible; padding: 6px; font-size: 9pt; color: #444;border-bottom:1px solid lightgray;}"),GM_addStyle(".notificationRow > div {margin-top: 2px;}"),GM_addStyle(".notificationRow.read {color: #AAA !important;}"),GM_addStyle(".notificationRow.read a {color: #888 !important;}"),GM_addStyle(".notificationRow:hover {background: #eee;}"),GM_addStyle("#noNotificationsMessage {text-align: center; line-height: 83px; font-size: 12pt; color: #646464;}"),GM_addStyle("#notificationsListButtons td {background: #CC3300;color: white;cursor: pointer;font-size: 10pt;height: 30px;line-height: 30px;text-align: center;border-right: 1px solid white;}"),GM_addStyle("#notificationsListButtons td:last-child {border: none;}"),GM_addStyle("#notificationsListButtons td:hover {background: #E64D1A;}"),GM_addStyle("#notificationsListButtons {width: 100%;}");var m,g,b,v,y,_,x,w,T,S,R,C,E="QUERY";f.migrateValues=function(e){f.helper.getValue("LAST_QUOTES_UPDATE")?e():f.helper.setValue("LAST_QUOTES_UPDATE",f.helper.getLocalValue("LAST_QUOTES_UPDATE"),function(){f.helper.setValue("LAST_READ_QUOTE",f.helper.getLocalValue("LAST_READ_QUOTE"),function(){f.helper.setValue("LAST_QUOTES",f.helper.getLocalValue("LAST_QUOTES"),e)})})},f.onNormalStart=function(){C=document.title;for(var e=f.helper.environment.user.name,t="",a=0;e.length>a;a++)t+=e.charCodeAt(a)>255?"\\"+e.charCodeAt(a):e.charAt(a);m="http://www.forocoches.com/foro/search.php?do=process&query="+escape(t)+"&titleonly=0&showposts=1",v=f.helper.getValue("LAST_QUOTES_UPDATE"),y=f.helper.getValue("LAST_READ_QUOTE"),_=f.helper.getValue("LAST_QUOTES"),x=Array(),_&&(x=JSON.parse(_)),g=f.preferences.refreshEvery,"off"!=g&&(g=parseInt(g));var n="quote",i=f.helper.getResourceText("quotehtml");SHURSCRIPT.templater.storeTemplate(n,i),SHURSCRIPT.templater.compile(n),r(),o()}}(jQuery,SHURSCRIPT.moduleManager.createModule),function(e,t){"use strict";function o(){""!==O.preferences.favoritesColor&&(O.preferences.favoritesBorderOnly?GM_addStyle(".favorite>td:nth-child(3) {border-left: 4px solid "+O.preferences.favoritesColor+" !important}"):GM_addStyle(".favorite>td:nth-child(3) {background-color:"+O.preferences.favoritesColor+" !important;}")),GM_addStyle(".fav img {display:none;} .fav {cursor: pointer; background-repeat:no-repeat; background-position: center; background-image:url('"+SHURSCRIPT.config.imagesURL+"fav.png"+"');min-width:20px;}"),GM_addStyle(".shurmenu_trigger img, .shurmenu_opened img {display:none;} .shurmenu_trigger, .shurmenu_opened {cursor: pointer; background-repeat:no-repeat; background-position: center; background-image:url('"+SHURSCRIPT.config.imagesURL+"roto2.gif"+"');min-width:20px;}"),GM_addStyle(".not_fav img {display:none;} .not_fav {cursor: pointer; background-repeat:no-repeat; background-position: center; background-image:url('"+SHURSCRIPT.config.imagesURL+"nofav.png"+"');min-width:20px;}"),GM_addStyle(".shur_estrella {width:30px;vertical-align:middle;} .shur_estrella a {cursor: pointer; width:20px; height:20px; display:block; background-repeat:no-repeat; background-position: center; background-image:url('"+SHURSCRIPT.config.imagesURL+"nofav.png"+"'); margin:0 auto;} .shur_estrella a.fav {background-image:url('"+SHURSCRIPT.config.imagesURL+"fav.png"+"');}"),""!==O.preferences.highlightColor&&(O.preferences.highlightBorderOnly?GM_addStyle(".highlighted>td:nth-child(3) {border-left: 4px solid "+O.preferences.highlightColor+"}"):GM_addStyle(".highlighted>td:nth-child(3) {background-color:"+O.preferences.highlightColor+";}")),O.preferences.highlightBold&&GM_addStyle(".highlightKeyword {text-decoration: underline; color: black;}"),GM_addStyle(".hiddenKeyword {text-decoration: line-through; color: black;}")}function a(){g(),b(),e("body").click(function(t){-1==t.target.className.indexOf("popover")&&e(".popover").length&&!jQuery.contains(e(".popover")[0],t.target)&&(e(".shurmenu_opened").not(""!=t.target.id?"#"+t.target.id:"").removeClass("shurmenu_opened"),-1==t.target.id.indexOf("statusicon")&&e(".popover").remove())}),L=JSON.parse(O.helper.getValue("HIDDEN_THREADS","[]")),y(),e("#threadslist tr").each(function(){try{var t={};t.row=e(this),t.title_td=e(this).find('td[id^="td_threadtitle_"]'),0!=t.title_td.length&&(t.title_link=t.title_td.find('div > a[id^="thread_title_"]').first(),t.href=t.title_link.attr("href"),t.id=parseInt(/.*showthread\.php\?.*t=([0-9]+).*/.exec(t.href)[1]),t.title=t.title_link.html(),t.creator_span=t.title_td.find("div.smallfont > span:last-child"),t.creator=t.creator_span.text(),t.icon_td=e(this).find("#td_threadstatusicon_"+t.id),r(t),t.icon_td.popover({content:s(t),container:"body",placement:"right",html:!0,trigger:"manual"}),t.icon_td.click(function(){e(".popover").remove(),e(this).popover("show"),e(".popover .popover-content").html(s(t)),e(this).addClass("shurmenu_opened")
}),t.icon_td.hover(function(){e(this).addClass("shurmenu_trigger")},function(){e(this).removeClass("shurmenu_trigger")}),A.push(t))}catch(o){alert(o)}})}function n(){var t=e("#threadtools_menu form>table tr:last a").attr("href");if(-1!=t.indexOf("subscription"))var o=parseInt(t.replace("subscription.php?do=addsubscription&t=",""),10);else var o=parseInt(t.replace("poll.php?do=newpoll&t=",""),10);var a=!1;a=S.indexOf(o)>=0?!0:!1;var n='<td class="shur_estrella"><a href="#" class="'+(a?"fav":"")+'"></a></td>';e("#poststop").next().find("td.smallfont").first().before(n),e("#posts").next().find("table td.smallfont").first().before(n),e(".shur_estrella a").each(function(){e(this).click(function(){return a?(a=!1,T(o,S),e(".shur_estrella a").each(function(){e(this).removeClass("fav")})):(a=!0,S.push(o),e(".shur_estrella a").each(function(){e(this).addClass("fav")})),x(),!1})})}function r(t){if("/search.php"==O.helper.environment.page)S.indexOf(t.id)>=0&&(t.row.addClass("favorite"),t.isFavorite=!0);else{var o;L.indexOf(t.id)>=0?(i(t),t.isHidden=!0):S.indexOf(t.id)>=0?(t.isFavorite=!0,O.preferences.favoritesOnTop&&(e(".favorite").length>0?e(".favorite").last().after(t.row):e(".highlighted").length>0?e(".highlighted").first().before(t.row):e("#threadslist > tbody[id^='threadbits_forum'] > tr").first().before(t.row)),t.row.addClass("favorite")):k&&(o=v(t.creator,k,"hiddenKeyword"))?(i(t),t.isHidden=!0,t.isHiddenByUser=!0,t.creator_span.html(o)):E&&(o=v(t.title,E,"hiddenKeyword"))&&(i(t),t.isHidden=!0,t.isHiddenByKeywords=!0,t.title=o,t.title_link.html(o)),M&&(o=v(t.title,M,"highlightKeyword"))&&(t.isHighlighted=!0,t.title_link.html(o),t.isHidden||t.isFavorite||!O.preferences.highlightedOnTop||(e(".highlighted").length>0?e(".highlighted").last().after(t.row):e(".favorite").length>0?e(".favorite").last().after(t.row):e("#threadslist > tbody[id^='threadbits_forum'] > tr").first().before(t.row)),t.row.addClass("highlighted"),t.isHiddenByKeywords&&R.find(".tcat").css("background","#FBBD97")),t.isHidden||-1!=t.icon_td.find("img").attr("src").indexOf("new.gif")||(O.preferences.hideReadThreads&&t.row.css("display","none"),P.push(t))}}function i(t){var o=e("#hiddenthreadslist");if(0==o.length){var a=e("#threadslist");o=e('<table id="hiddenthreadslist" class="tborder" cellspacing="1" cellpadding="5" border="0" width="100%" align="center">'),o.append(a.find("tbody").first().clone());var n=a.prev(),r=e('<table id="hiddenthreadsheader" class="tborder" cellspacing="1" cellpadding="5" border="0" width="100%" align="center" style="cursor: pointer;"><tr><td class="tcat" width="100%"><span style="background: url(\''+SHURSCRIPT.config.imagesURL+'trash-black.png\') no-repeat scroll 0% 0% transparent; height: 16px; display: inline-block; vertical-align: middle; width: 20px; margin-top: -2px;"></span><span id="numhiddenthreads">0</span> Hilo(s) oculto(s)</td></tr></table>');r.click(function(){o.parent().slideToggle()}),n.before(o),o.before(r),o.wrap('<div id="hiddenthreadslistwrapper" style="overflow: hidden;"></div>'),o.parent().hide(),e("#hiddenthreadsheader, #hiddenthreadslistwrapper").wrapAll('<div id="hiddenthreads" style="margin-bottom: 15px;"></div>'),R=e("#hiddenthreads")}o.append(t.row),I++,1==I&&R.show(),R.find("#numhiddenthreads").html(I)}function s(t){var o=e("<div class='shurscript'/>");return(!t.isHidden||t.isHiddenByKeyword)&&o.append(m(t,"Quitar favorito","Favorito",SHURSCRIPT.config.imagesURL+"star.png",t.isFavorite,function(){l(t),t.icon_td.removeClass("shurmenu_opened"),e(".popover").remove()})),"/search.php"!=O.helper.environment.page&&o.append(m(t,"Mostrar de nuevo","Ocultar",SHURSCRIPT.config.imagesURL+"trash.png",t.isHidden&&!t.isHiddenByKeyword,function(){d(t),t.icon_td.removeClass("shurmenu_opened"),e(".popover").remove()},"btn-danger")),o}function l(e){e.isFavorite?p(e):c(e)}function d(e){e.isHidden?e.row.fadeOut({complete:function(){h(e),e.row.show()}}):e.row.fadeOut({complete:function(){u(e),e.row.show()}})}function c(t){S.push(t.id),e(t.row).addClass("favorite"),t.isFavorite=!0,x()}function p(t){T(t.id,S),e(t.row).removeClass("favorite"),t.isFavorite=!1,x()}function u(e){e.isHidden=!0,L.push(e.id),(e.isFavorite||S.indexOf(e.id)>=0)&&p(e),i(e),w()}function h(e){T(e.id,L),e.icon_td.removeClass("shurmenu_opened"),e.isHidden=!1,f(e),w()}function f(t){e("#threadslist > tbody[id^='threadbits_forum']").append(t.row),I--,R.find("#numhiddenthreads").html(I),0==I&&(R.hide(),R.find("#hiddenthreadslistwrapper").hide())}function m(t,o,a,n,r,i,s){var l=e('<button type="button" data-toggle="button" style="margin: 0 5px; display: inline-block;" class="btn btn-sm '+(s?s:"btn-default")+'"><span style="background: url(\''+n+"') no-repeat scroll 0% 0% transparent; height: 16px; display: inline-block; vertical-align: middle; width: 20px; margin-top: -2px;\"></span><span>"+(r?o:a)+"</span></button>");return l.click(function(){var t;t=e(this).hasClass("active")?a:o,e(this).find("span")[0].style.backgroundImage=n,e(this).find("span")[1].innerHTML=t}),r&&l.addClass("active"),l.click(i),l}function g(){var t=e("#stickies_collapse").length?e("#stickies_collapse"):e("#forumtools"),o=e('<a rel="nofollow">'+(O.preferences.hideReadThreads?"Mostrar todos los hilos":"Mostrar solo los hilos no leídos")+"</a>");C=e('<td class="vbmenu_control" nowrap="nowrap" style="cursor: pointer;"></td>'),C.append(o),C.click(function(){O.preferences.hideReadThreads=!O.preferences.hideReadThreads,O.preferences.hideReadThreads?(e.each(P,function(e,t){t.hideRead=!0,t.row.css("display","none")}),o.html("Mostrar todos los hilos")):(e.each(P,function(e,t){t.hideRead=!1,t.row.css("display","table-row")}),o.html("Mostrar solo los hilos no leídos")),O.storePreferences()}),t.before(C)}function b(){var t=e("<input name='quickFilter' placeholder='Filtro rápido...'/>"),o=e("<td class='tcat' style='padding:0px 4px;'/>");o.append(t),"/search.php"==O.helper.environment.page?e("#threadslist .tcat span").last().append(o):C.before(o);var a,n=function(){if(""==t.val()||2>=t.val().length)A.forEach(function(e){e.hideRead||e.row.css("display","table-row"),e.title_link.html(e.title)});else{var e=_(t.val(),!1,!1);A.forEach(function(t){if(!t.isHidden){var o;!t.hideRead&&(o=v(t.title,e,"highlightKeyword"))?(t.title_link.html(o),t.row.css("display","table-row")):(t.title_link.html(t.title),t.row.css("display","none"))}})}};t.keydown(function(e){27==e.which?setTimeout(function(){t.val(""),t.trigger("input")},1):13==e.which&&e.preventDefault()}),t.on("input",function(){clearTimeout(a),a=setTimeout(n,200)})}function v(e,t,o){for(var a=!1,n=t&&t.exec(e),r=e;null!=n&&""!=n[0];)r=r.replace(n[0].trim(),"<span class='"+o+"'>"+n[0].trim()+"</span>"),e=e.substring(n.index+n[0].length),n=t.exec(e),a=!0;return a&&r}function y(){if(O.preferences.hiddenKeywords&&""!=O.preferences.hiddenKeywords)try{E=_(O.preferences.hiddenKeywords,O.preferences.hiddenKeywordsIsRegex)}catch(e){E=null,bootbox.alert("Ha ocurrido un error. Revisa la expresión regular que has introducido para ocultar hilos.")}if(O.preferences.hiddenUsers&&""!=O.preferences.hiddenUsers)try{k=_(O.preferences.hiddenUsers,!1)}catch(e){k=null,bootbox.alert("Ha ocurrido un error. Revisa la expresión regular que has introducido para ocultar hilos por usuario.")}if(O.preferences.highlightKeywords&&""!=O.preferences.highlightKeywords)try{M=_(O.preferences.highlightKeywords,O.preferences.highlightKeywordsIsRegex)}catch(e){M=null,bootbox.alert("Ha ocurrido un error. Revisa la expresión regular que has introducido para resaltar hilos.")}}function _(e,t,o){var a;return t?a=RegExp(e,"i"):(e=e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),e=e.replace(/[\ ]*[\,]+[\ ]*$/,""),a=o===undefined||o?"(\\b|\\ )":"",a+="("+e.replace(/[aáà]/gi,"[aáà]").replace(/[eéè]/gi,"[eéè]").replace(/[iíï]/gi,"[iíï]").replace(/[oóò]/gi,"[oóò]").replace(/[uúü]/gi,"[uúü]").replace(/[\ ]*[\,]+[\ ]*/g,"|")+")",(o===undefined||o)&&(a+="(\\b|\\ )"),a=RegExp(a,"i")),a}function x(){O.helper.setValue("FAVORITES",JSON.stringify(S))}function w(){O.helper.setValue("HIDDEN_THREADS",JSON.stringify(L))}function T(e,t){var o=t.indexOf(e);o>-1&&t.splice(o,1)}var S,R,C,E,k,M,O=t({id:"FilterThreads",name:"Filtrado de hilos",author:"xusoO",version:"0.2",description:"Añade varias opciones a la lista de hilos de un subforo: Marcar hilos como favoritos, resaltarlos, u ocultar los temas que no te interesen. Ya sea de forma manual o automática mediante palabras clave.",domain:["/forumdisplay.php","/showthread.php","/search.php"],initialPreferences:{enabled:!0,hideReadThreads:!1,hiddenUsers:"",hiddenKeywords:"",hiddenKeywordsIsRegex:!1,highlightKeywords:"",highlightKeywordsIsRegex:!1,highlightColor:"#FAF7DD",highlightBorderOnly:!1,highlightBold:!0,highlightedOnTop:!0,favoritesColor:"#D5E6EE",favoritesBorderOnly:!1,favoritesOnTop:!0}}),A=[],P=[],L=[],I=0;O.migrateValues=function(e){O.helper.setValue("FAVORITES",O.helper.getLocalValue("FAVORITES"),function(){O.helper.setValue("HIDDEN_THREADS",O.helper.getLocalValue("HIDDEN_THREADS"),e)})},O.normalStartCheck=function(){return!0},O.onNormalStart=function(){o(),S=JSON.parse(O.helper.getValue("FAVORITES","[]")),"/forumdisplay.php"==O.helper.environment.page||"/search.php"==O.helper.environment.page?a():"/showthread.php"==O.helper.environment.page&&n()},O.getPreferenceOptions=function(){var e=O.helper.createPreferenceOption;return[e({type:"header",caption:"Ocultar hilos",subCaption:"Puedes ocultar hilos de forma automática, ya sea mediante una lista negra de usuarios o por palabras clave en el título de los temas:"}),e({type:"checkbox",mapsTo:"hideReadThreads",caption:"Mostrar solo hilos no leídos.",subCaption:'<span style="color:gray;">De cualquier modo aparecerá un botón para ocultarlos o mostrarlos. Esta opción solo cambia el comportamiento por defecto.</span>'}),e({type:"text",mapsTo:"hiddenUsers",caption:"Ignorar hilos por usuario <b>(separados por comas)</b>"}),e({type:"text",mapsTo:"hiddenKeywords",caption:"Ignorar hilos por palabras clave <b>(separadas por comas)</b>"}),e({type:"checkbox",mapsTo:"hiddenKeywordsIsRegex",caption:"<b>Avanzado:</b> Usar expresión regular en las palabras clave"}),e({type:"header",caption:"Resaltar hilos",subCaption:"Los hilos que contengan cualquiera de estas palabras serán resaltados con los colores selccionados de entre el resto de hilos:"}),e({type:"text",mapsTo:"highlightKeywords",caption:"Resaltar hilos por palabras clave <b>(separadas por comas)</b>"}),e({type:"checkbox",mapsTo:"highlightKeywordsIsRegex",caption:"<b>Avanzado:</b> Usar expresión regular en las palabras clave"}),e({type:"color",mapsTo:"highlightColor",caption:"Color",subCaption:'El color de fondo para los hilos resaltados. Por defecto <span class="badge">'+O.initialPreferences.highlightColor+"</span>"}),e({type:"checkbox",mapsTo:"highlightBorderOnly",caption:"Aplicar color solo al borde izquierdo"}),e({type:"checkbox",mapsTo:"highlightBold",caption:"Resaltar palabras clave en los títulos de los hilos"}),e({type:"checkbox",mapsTo:"highlightedOnTop",caption:"Colocar siempre en primer lugar los hilos resaltados"}),e({type:"header",caption:"Hilos favoritos",subCaption:"Mostrará un icono al lado de cada hilo para marcarlo como favorito. Los hilos favoritos destacarán entre los demás cuando el usuario entre a algún subforo:"}),e({type:"color",mapsTo:"favoritesColor",caption:"Color",subCaption:'Color de fondo", "El color de fondo para los hilos favoritos. Por defecto <span class="badge">'+O.initialPreferences.favoritesColor+"</span>"}),e({type:"checkbox",mapsTo:"favoritesBorderOnly",caption:"Aplicar color solo al borde izquierdo"}),e({type:"checkbox",mapsTo:"favoritesOnTop",caption:"Colocar siempre en primer lugar los hilos marcados como favoritos"})]}}(jQuery,SHURSCRIPT.moduleManager.createModule),function(e,t){"use strict";function o(){var t=b();v()||e("#"+t.editorid+"_textarea").css("width",600),unsafeWindow.switch_editor_mode(t.editorid),unsafeWindow.is_saf=!1,unsafeWindow.is_moz=!0,t.wysiwyg_mode=1,0==e("#"+t.editorid+"_cmd_switchmode").length&&e('<td><div id="'+t.editorid+'_cmd_switchmode" class="imagebutton" style="background: none repeat scroll 0% 0% rgb(225, 225, 226); color: rgb(0, 0, 0); padding: 1px; border: medium none;"><img height="20" width="21" alt="Cambiar Modo de Editor" src="http://cdn.forocoches.com/foro/images/editor/switchmode.gif" title="Cambiar Modo de Editor"></div></td>').insertAfter(e("#vB_Editor_QR_cmd_resize_0_99").parent())}function a(){v()&&E.preferences.multiQuickReply&&s(),E.preferences.autoGrow&&i(),E.preferences.savePosts&&d(),E.preferences.autoSendReply&&c(),v()&&e("a[href^='editpost.php?do=editpost']").click(function(){var t=setInterval(function(){var o="vB_Editor_QE_"+unsafeWindow.vB_QuickEditor.editorcounter;if(e("#"+o+"_editor").length>0&&T[o]){clearInterval(t);var a=T[o];0==a.wysiwyg_mode?(unsafeWindow.switch_editor_mode(o),a.wysiwyg_mode=1,t=setInterval(function(){T[o].editdoc.body&&(clearInterval(t),r(o))},500)):r(o)}},500)})}function n(){v()&&E.preferences.iconsAndButtons&&(h(),p()),e("input[name='sbutton'], input[name='preview']").on("click",function(){var e=_();e=e.replace(/<div>/g,"<br>").replace(/(<br>)?(<\/div>)/g,""),x(e),m()})}function r(t){var o=T[t];if(E.preferences.autoGrow){try{-1!=navigator.userAgent.indexOf("AppleWebKit")&&o.editdoc.write("<!doctype HTML>\n"+o.editdoc.head.outerHTML+o.editdoc.body.outerHTML)}catch(a){}e(o.editdoc.body).on("input",function(){o.editbox.style.height=Math.max(o.editdoc.body.offsetHeight+30,200)+"px"}),e(o.editdoc.body).trigger("input")}}function i(){var t=b();try{-1!=navigator.userAgent.indexOf("AppleWebKit")&&t.editdoc.write("<!doctype HTML>\n"+t.editdoc.head.outerHTML+t.editdoc.body.outerHTML)}catch(o){}R=e('<input type="checkbox" checked/>')[0],R.onclick=function(){R.checked?m():t.editbox.style.height=C+"px"},e(t.controlbar).find("> table > tbody > tr").first().append("<td></td>").append(R),R.title="Crecer automáticamente con el contenido",C=v()?g():unsafeWindow.fetch_cookie("editor_height")||430,e(t.editdoc.body).on("input",function(){R.checked&&m()}),e("#vB_Editor_QR_cmd_resize_1_99").click(function(){R.checked=!1,m()}),e("#vB_Editor_QR_cmd_resize_0_99").click(function(){R.checked=!1,m()}),m()}function s(){var t=function(){if(y()){var t=this.id.replace("qr_",""),o="",a=!1,n=unsafeWindow.fetch_cookie("vbulletin_multiquote");if(n&&""!=n&&(n=n.split(","),n.forEach(function(n){if(t==n&&(a=!0),0!=e("#post"+n).length){o+=l(n);var r=e('img[id^="mq_'+n+'"]');r.attr("src",r.attr("src").replace("_on.gif","_off.gif"))}})),a||(o+=l(t)),o+="<br>",""!=_().trim().replace(/\<br\>/g,"")){var r=E.preferences.postOverwrite;switch(r){case"ASK":bootbox.dialog({message:"Actualmente hay texto escrito en el editor <b>¿Quieres añadir la cita al texto actual o sobreescribirlo?</b>",buttons:[{label:"Cancelar",className:"btn-default"},{label:"Añadir",className:"btn-primary",callback:function(){w(o),m()}},{label:"Sobreescribir",className:"btn-danger",callback:function(){x(""),w(o),m()}}]});break;case"OVERWRITE":x("");case"APPEND":w(o),m()}}else w(o),m();unsafeWindow.set_cookie("vbulletin_multiquote","")}};e("body").on("click",'a[id^="qr_"]',t),e("#"+b().editorid).siblings().filter("fieldset").first().hide()}function l(t){var o=e("#post"+t).find(".bigusername").text(),a=e("#post_message_"+t).clone();return a.find("div[style*='margin:20px; margin-top:5px;']").remove(),a.find("div[style='margin:20px; margin-top:5px'] > .smallfont:contains('Código')").parent().each(function(){var t=e(this).find(".alt2"),o=e(this).find(".smallfont").text();return"Código HTML:"==o?(t.find("span").each(function(){var t=this.nextSibling&&0==this.nextSibling.textContent.indexOf("\n")?"</br>":"";this.outerHTML=e(this).text().replace(/</g,"&lt;")+t}),t=t.html().replace(/ /g,"&nbsp;"),e(this).replaceWith("[HTML]</br>"+t.trim()+"</br>[/HTML]"),undefined):"Código PHP:"==o?(t=t.find("code span"),t.find("span").each(function(){this.outerHTML=this.innerHTML}),t=t.html().replace(/ /g,"&nbsp;"),e(this).replaceWith("[PHP]</br>"+t.trim()+"</br>[/PHP]"),undefined):(t=t.text(),t=t.replace(/\n/g,"</br>").replace(/\ /g,"&nbsp;"),"Código:"==o&&e(this).replaceWith("[CODE]</br>"+t.trim()+"</br>[/CODE]"),undefined)}),a.find("iframe.youtube-player").each(function(){var t=e(this).attr("src").match(/^.*\/(.*)/)[1];e(this).replaceWith("[YOUTUBE]"+t+"[/YOUTUBE]")}),a.find('img[class!="inlineimg"]').each(function(){e(this).replaceWith("[IMG]"+e(this).attr("src")+"[/IMG]")}),"[QUOTE="+o+";"+t+"]"+a.html().trim()+"[/QUOTE]"+"<br><br>"}function d(){var t=e('input[name="t"]').val();t||"/newthread.php"!=E.helper.environment.page||(t="new_thread");var o=E.helper.getValue("POST_BACKUP");o&&v()&&(o=JSON.parse(o),o.threadId==t&&(""==_().trim().replace(/\<br\>/g,"")&&x(o.postContents),m()));var a,n=function(){clearTimeout(a),a=setTimeout(function(){E.helper.setValue("POST_BACKUP",JSON.stringify({threadId:t,postContents:_()}))},500)};if(e(b().editdoc.body).on("input",n),v())e("input[name='sbutton']").on("click",function(){E.helper.deleteValue("POST_BACKUP")});else{var r=e("input[name='sbutton']");r.attr("type","button");var i=r.parents("form")[0];r.on("click",function(){i.onsubmit()&&E.helper.deleteValue("POST_BACKUP",function(){i.submit()})})}}function c(){var t=function(){var t;unsafeWindow.autoReplyInterval&&clearInterval(unsafeWindow.autoReplyInterval);var o=setInterval(function(){var a=e("td.alt1 ol");a.length>0&&-1!=a.text().indexOf("Debes esperar")?(a=a.find("li").first(),t=t||parseInt(a.text().match(/en ([\d]+)/)[1]),0>=t--?(clearInterval(o),E.helper.deleteValue("POST_BACKUP"),e("form[name='vbform']").submit()):a.html("Debes esperar al menos 30 segundos entre cada envio de nuevos mensajes. El mensaje se enviará automáticamente en "+t+" segundos. <a style='color: #CC3300;cursor:pointer;' onclick='clearInterval(autoReplyInterval); this.remove();'>Cancelar</a>")):clearInterval(o)},1e3);unsafeWindow.autoReplyInterval=o};v()?e("input[name='sbutton']").on("click",t):t()}function p(){var t=e('<fieldset class="fieldset" style="margin:3px 0px 0px 0px"><legend>Iconos</legend></fieldset>');e("#"+b().editorid).parent().append(t),t.append(u(":roto2:","http://cdn.forocoches.com/foro/images/smilies/goofy.gif",164)),t.append(u(":sisi3:","http://cdn.forocoches.com/foro/images/smilies/sisi3.gif",324)),t.append(u(":mola:","http://cdn.forocoches.com/foro/images/smilies/thumbsup.gif",48)),t.append(u(":cantarin:","http://cdn.forocoches.com/foro/images/smilies/Sing.gif",101)),t.append(u(":qmeparto:","http://cdn.forocoches.com/foro/images/smilies/meparto.gif",142)),t.append(u(":nusenuse:","http://cdn.forocoches.com/foro/images/smilies/nusenuse.gif",283)),t.append(u(":facepalm:","http://cdn.forocoches.com/foro/images/smilies/facepalm.gif",318)),t.append(u(":zpalomita","http://cdn.forocoches.com/foro/images/smilies/icon_popcorn.gif",215)),t.append(u(":zplatano2","http://cdn.forocoches.com/foro/images/smilies/b2.gif",236)),t.append(u(":number1:","http://cdn.forocoches.com/foro/images/smilies/number_one.gif",268)),t.append(u(":elrisas:","http://cdn.forocoches.com/foro/images/smilies/qmeparto.gif",76)),t.append(u(":gaydude:","http://cdn.forocoches.com/foro/images/smilies/gaydude.gif",264)),t.append(u(":sisi1:","http://cdn.forocoches.com/foro/images/smilies/sisi1.gif",299)),t.append(u(":babeando:","http://cdn.forocoches.com/foro/images/smilies/babeando.gif",274)),t.append(u(":elboinas:","http://cdn.forocoches.com/foro/images/smilies/elboinas.gif",314)),t.append(u(":qtedoy:","http://cdn.forocoches.com/foro/images/smilies/smiley_1140.gif",191)),t.append(u(":abrazo:","http://cdn.forocoches.com/foro/images/smilies/abrazo.gif",161));var o=e("<a href='#qrform'>Más...</a>");o.click(function(){b().open_smilie_window(785,500)}),t.append(o)}function u(e,t,o){return'<img border="0" class="inlineimg" src="'+t+'" style="cursor: pointer; padding: 5px;" onclick="vB_Editor.'+b().editorid+".insert_smilie(undefined, '"+e+"', '"+t+"', "+o+')">'}function h(){S=function(e){e=unsafeWindow.do_an_e(e),"click"==e.type&&T[b().editorid].format(e,this.cmd,!1,!0),T[b().editorid].button_context(this,e.type)};var t=e(b().controlbar).find("> table > tbody > tr > td:nth-child(8)"),o=[];o.push(f("justifyleft","Alinear a la Izquierda")),o.push(f("justifycenter","Alinear al Centro")),o.push(f("justifyright","Alinear a la Derecha")),o.push('<td><img width="6" height="20" alt="" src="http://cdn.forocoches.com/foro/images/editor/separator.gif"></td>'),o.push(f("insertorderedlist","Lista Ordenada")),o.push(f("insertunorderedlist","Lista sin Ordenar")),o.push('<td><img width="6" height="20" alt="" src="http://cdn.forocoches.com/foro/images/editor/separator.gif"></td>'),o.push(f("undo","Deshacer")),o.push(f("redo","Rehacer")),o.push('<td><img width="6" height="20" alt="" src="http://cdn.forocoches.com/foro/images/editor/separator.gif"></td>'),o.push(f("wrap0_code","Envolver Etiquetas [CODE]","code")),o.push(f("wrap0_html","Envolver Etiquetas [HTML]","html")),o.push(f("wrap0_php","Envolver Etiquetas [PHP]","php")),o.push('<td><img width="6" height="20" alt="" src="http://cdn.forocoches.com/foro/images/editor/separator.gif"></td>'),t.after(o)}function f(t,o,a){var n=a?a:t,r=e('<div id="vB_Editor_001_cmd_'+t+'" class="imagebutton" style="background: none repeat scroll 0% 0% rgb(225, 225, 226); color: rgb(0, 0, 0); padding: 1px; border: medium none;"><img width="21" height="20" alt="'+o+'" src="http://cdn.forocoches.com/foro/images/editor/'+n+'.gif" title="'+o+'"></div>')[0];return r.editorid=b().editorid,r.cmd=t,r.onclick=r.onmousedown=r.onmouseover=r.onmouseout=S,e("<td></td>").append(r)}function m(){R&&R.checked&&(b().editbox.style.height=Math.max(g()+30,C)+"px")}function g(){var e=b().editdoc.body.offsetHeight;return Math.max(e,100)}function b(){return"/showthread.php"==E.helper.environment.page?T.vB_Editor_QR:T.vB_Editor_001}function v(){return"vB_Editor_QR"==b().editorid}function y(){return 1==b().wysiwyg_mode}function _(){return b().get_editor_contents()}function x(e){b().set_editor_contents(e)}function w(e){b().insert_text(e)}var T,S,R,C,E=t({id:"BetterPosts",name:"Editor de posts mejorado",author:"xuso0",version:"0.2",description:"Activa varias opciones nuevas en la creación de posts e hilos, tanto el de respuesta rápida como el avanzado. <b>BETA</b>",domain:["/showthread.php","/newthread.php","/newreply.php","/editpost.php"],initialPreferences:{enabled:!0,iconsAndButtons:!0,autoGrow:!0,multiQuickReply:!0,autoSendReply:!0,savePosts:!0,postOverwrite:"ASK"}});E.normalStartCheck=function(){return!0},E.onNormalStart=function(){if(T=unsafeWindow.vB_Editor,n(),y())a();else{o();var e=setInterval(function(){b().editdoc.body&&(clearInterval(e),a())},500)}},E.getPreferenceOptions=function(){var e=E.helper.createPreferenceOption;return[e({type:"checkbox",mapsTo:"iconsAndButtons",caption:"Mostrar nuevos botones e iconos en el formulario de respuesta rápida"}),e({type:"checkbox",mapsTo:"autoGrow",caption:"La caja de texto crece a medida que se va escribiendo el post"}),e({type:"checkbox",mapsTo:"multiQuickReply",caption:"Permitir multi-cita con el botón de Respuesta rápida (y mostrar la propia cita en la caja de texto)"}),e({type:"checkbox",mapsTo:"autoSendReply",caption:"Auto-enviar el mensaje pasados los 30 segundos de espera entre post y post"}),e({type:"checkbox",mapsTo:"savePosts",caption:"Guardar copia de los mensajes sin enviar para evitar perder el contenido de un post accidentalmente"}),e({type:"radio",elements:[{value:"ASK",caption:"Preguntar"},{value:"APPEND",caption:"Añadir"},{value:"OVERWRITE",caption:"Sobreescribir"}],caption:"Cuando cites con respuesta rápida y haya texto escrito en el editor ¿Quieres añadir la cita al texto actual o sobreescribirlo?:",mapsTo:"postOverwrite"})]}}(jQuery,SHURSCRIPT.moduleManager.createModule),function(e,t){"use strict";var o=t({id:"Scrollers",name:"Scroll arriba y abajo",author:"xusoO",version:"0.1",description:"Aparecerán dos flechas en la parte inferior del foro; una para volver al principio de la página y la otra para ir al final.",domain:"ALL",initialPreferences:{enabled:!1,upOrDown:"both",side:"center"}});o.normalStartCheck=function(){return!0},o.onNormalStart=function(){"center"!=o.preferences.side?GM_addStyle("#scrollers {opacity: 0.5;bottom: 5px;"+o.preferences.side+": 13px;position: fixed;}"):GM_addStyle("#scrollers {opacity: 0.5;bottom: 5px;left: calc(50% - 55px);position: fixed;}"),GM_addStyle("#scrollers:hover {opacity: 0.9;}"),GM_addStyle('.scrollerArrow {background: url("'+SHURSCRIPT.config.imagesURL+'scroller.png") no-repeat scroll 0 0 transparent;background-size: 50px;cursor: pointer;height: 50px;width: 50px;display: inline-block;margin: 5px;opacity: 0.4;}'),GM_addStyle(".scrollerArrow:hover {opacity: 0.7;}"),GM_addStyle(".scrollerArrow#scrollToBottomArrow {transform: rotate(180deg);-webkit-transform: rotate(180deg);}");var t=e("<div id='scrollers'></div>"),a=e("<div class='scrollerArrow' id='scrollToTopArrow'></div>");a.click(function(){e("html, body").stop().animate({scrollTop:"0px"},800)});var n=e("<div class='scrollerArrow' id='scrollToBottomArrow'></div>");n.click(function(){e("html, body").stop().animate({scrollTop:(e("#qrform").length>0?e("#qrform").offset().top:e("html").height())+"px"},800)}),"up"==o.preferences.upOrDown?t.append(a):"down"==o.preferences.upOrDown?t.append(n):t.append(a).append(n),e(document.body).append(t)},o.getPreferenceOptions=function(){var e=o.helper.createPreferenceOption;return[e({type:"radio",elements:[{value:"both",caption:"Ambas fechas"},{value:"up",caption:"Solo la de ir al principio"},{value:"down",caption:"Solo la de ir al final"}],caption:"Mostrar:",mapsTo:"upOrDown"}),e({type:"radio",elements:[{value:"left",caption:"A la izquierda"},{value:"right",caption:"A la derecha"},{value:"center",caption:"Centradas"}],caption:"Alinear:",mapsTo:"side"})]}}(jQuery,SHURSCRIPT.moduleManager.createModule),function(e,t,o){"use strict";function a(){var t=e("#vB_Editor_001_textarea");if(t!=o){var a=document.evaluate("//*[@id='vB_Editor_001_smiliebox']",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,n=document.createElement("fieldset");n.title="ShurScript",n.style.marginBottom="10px";var i=document.createElement("legend");i.innerHTML="ShurScript",a.parentNode.insertBefore(n,a),n.appendChild(i);var s=document.createElement("input");s.className="button",s.type="BUTTON",s.style.cursor="pointer",s.addEventListener("click",r,!1),s.setAttribute("id","butNestQuote"),s.value=p,n.appendChild(s)}}function n(e,t){var o=jQuery("#butNestQuote"),a=jQuery("#vB_Editor_001_textarea");o.attr("disabled",!e),a.attr("disabled",!e),o.val(t)}function r(){var e=jQuery("#vB_Editor_001_textarea");n(!1,"Trabajando...");var t=e.val().toUpperCase();if(f=t.search(m),f>=0){var o=f+7;for(g="\n",f=t.indexOf("]",f)+1;" "==t.substr(f,1)||"	"==t.substr(f,1)||"\n"==t.substr(f,1);)"\n"==t.substr(f,1)&&(g=""),f++;for(;"[QUOTE="==t.substr(f,7)&&t.indexOf(";",f)>0&&t.indexOf("]",f)>t.indexOf(";",f);)for(g="\n",o=f+7,f=t.indexOf("]",f)+1;" "==t.substr(f,1)||"	"==t.substr(f,1)||"\n"==t.substr(f,1);)"\n"==t.substr(f,1)&&(g=""),f++;o=t.indexOf(";",o)+1,b=t.substring(o,t.indexOf("]",o));var a=h+"showpost.php?p="+b;c=new XMLHttpRequest,c.onreadystatechange=i,c.open("GET",a,!0),c.send(null)}else n(!0,"Anidar cita"),bootbox.alert(u+"no se han encontrado citas para anidar.")}function i(){if(4==c.readyState){var e=!0,t="";if(200!=c.status&&0>c.responseText.indexOf('id="post_message_'+b+'"')&&(e=!1),e){var o=document.createElement("div");o.innerHTML=c.responseText,t=document.evaluate("//div[@id='post_message_"+b+"']//img[@alt='Ver Mensaje']/..",o,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,null==t?e=!1:t=t.href,o.innerHTML=""}if(e){var a=t.match(/[?&]p=\d+/);null==a?e=!1:t=a[0].substr(3)}if(e){var r=jQuery("#butNestQuote");r.value="Citando...";var i=h+"newreply.php?do=newreply&p="+t;c=new XMLHttpRequest,c.onreadystatechange=l,c.open("GET",i,!0),c.send(null)}e||(n(!0,"Anidar cita"),null==t?bootbox.alert(u+"El mensaje no posee ninguna cita o ya ha sido citado."):bootbox.alert("No se ha podido obtener el post original (status="+c.status+").\nForoCoches podría estar caído. ¡Guarda una copia del mensaje!"))}}function s(e){var t=document.createElement("div");t.innerHTML=e;var o=t.childNodes[0].nodeValue;return t.removeChild(t.firstChild),o}function l(){if(4==c.readyState){var e=!0,t="";if(200!=c.status&&0>c.responseText.indexOf('id="vB_Editor_001_textarea"')&&(e=!1),e){var o=c.responseText.indexOf('id="vB_Editor_001_textarea"'),a=-1;o>=0&&(o=c.responseText.indexOf("[QUOTE",o)),o>=0&&(a=c.responseText.indexOf("[/QUOTE]",o)),0>o?e=!1:t=c.responseText.substring(o,a)+"\n[/QUOTE]"}if(e){var r=jQuery("#vB_Editor_001_textarea");r.val(r.val().substr(0,f)+g+s(t)+"\n"+r.val().substr(f));try{var i=jQuery("#vB_Editor_001_iframe")[0].contentWindow.document.getElementsByClassName("wysiwyg")[0];i.innerHTML=i.innerHTML.replace(/\n/g,""),i.innerHTML=i.innerHTML.replace(/\[QUOTE.*\].*\[\/QUOTE\]/,r.val().substr(0,f)+g+"\n"+r.val().substr(f))}catch(l){}}n(!0,"Anidar cita"),e||null==quoteid&&bootbox.alert("No se ha podido obtener el post original (status="+c.status+").\nForoCoches podría estar caído. ¡Guarda una copia del mensaje!")}}var d=t({id:"NestedQuotes",name:"Citas anidadas",author:"Fritanga",version:"0.1",description:"Permite ir anidando citas hacia arriba hasta el post original",domain:["/newreply.php"],initialPreferences:{enabled:!0}}),c=null,p="Anidar cita",u="No se pudo anidar la cita: ",h=document.URL.substr(0,document.URL.indexOf("newreply.php")),f=-1,m=/\[QUOTE=[^;\]]+;/,g="\n",b=null;d.normalStartCheck=function(){return!0},d.onNormalStart=function(){a()}}(jQuery,SHURSCRIPT.moduleManager.createModule),function(e,t){"use strict";var o=t({id:"BottomNavigation",name:"Barra de navegación duplicada debajo",author:"TheBronx + Fritanga",version:"1.0",description:"Copia la tabla con la navegación a la parte inferior del foro.",domain:["/showthread.php","/newreply.php"]});o.normalStartCheck=function(){return!0},o.onNormalStart=function(){e("#qrform").before('<table width="100%" cellspacing="1" cellpadding="5" border="0" align="center" class="tborder navigation-bot">'+e(".page>div>table").html()+"</table><br>"),e(".navigation-bot .notifications").parent().remove();var t=e(".fjsel").closest("table.tborder"),o=t.find("div.smallfont").parent();e(".tborder.navigation-bot .alt1").after(o),o.addClass("alt1"),t.remove()}}(jQuery,SHURSCRIPT.moduleManager.createModule),function(e,t){"use strict";function o(){"http://www.forocoches.com/foro/search.php?do=process"===location.href?document.getElementById("searchform").submit():location.href+="&ts="+(new Date).getTime()}function a(){i.innerHTML="Debes esperar al menos "+l+" segundos entre cada búsqueda. Faltan aún "+s+" segundos. [ Recarga automática desactivada ]",s=288,d=!0}function n(){if(!d)if(s--,s>0){var t=e("<a href='#'>Cancelar</a>").click(function(){return a(),!1});i.innerHTML="Debes esperar al menos "+l+" segundos entre cada búsqueda. Faltan aún "+s+" segundos. &mdash; ",e(i).append(t),setTimeout(n,967)}else{var t=e("<a href='#'>Refrescar</a>").click(function(){return o(),!1});i.innerHTML="Cargando… &mdash; ",e(i).append(t),o()}}var r=t({id:"RefreshSearch",name:"Actualizar búsquedas en espera",author:"Electrosa",version:"0.2",description:"Recarga automáticamente las búsquedas en las que el sistema obliga a esperar varios segundos, evitando así tener que actualizar manualmente la página.",domain:["/search.php"],initialPreferences:{enabled:!0},preferences:{}});r.normalStartCheck=function(){return!0};var i,s,l,d=!1;r.onNormalStart=function(){if(-1!==location.href.indexOf("/search.php?do=")){i="ForoCoches"===document.title?document.getElementsByClassName("panel")[0].childNodes[1].childNodes[3]:document.querySelectorAll("td.alt1 ol li")[0];var e=i.innerHTML;if(e){var t=e.length;s=parseInt(e.substring(t-12,t-9)),isNaN(s)||(l=parseInt(e.substring(23,26)),setTimeout(n,967))}}}}(jQuery,SHURSCRIPT.moduleManager.createModule),function(e,t){"use strict";
function o(e){var t=new XMLHttpRequest;t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){var e=t.responseText,o=new DOMParser,r=o.parseFromString(e,"text/html"),i=a(r.querySelector("#posts div.page"));sessionStorage["op_"+d]=i,n(i)}},t.open("GET","showthread.php?t="+e,!0),t.send()}function a(e){var t;return(t=e.getElementsByClassName("bigusername")[0])?t.innerHTML:(t=e.querySelector("td.alt2 > a"))?t.innerHTML:null}function n(e){if(!e)return console_log("ERROR"),undefined;var t=l.helper.environment.user.name;GM_addStyle(".op_post, .op_quote { border: 1px solid "+l.preferences.opPostsColor+" !important; border-left: 5px solid "+l.preferences.opPostsColor+" !important; } .op_post td.alt2 { width: 171px; }"),GM_addStyle(".my_post, .my_quote { border: 1px solid "+l.preferences.myPostsColor+" !important; border-left: 5px solid "+l.preferences.myPostsColor+" !important; } .my_post td.alt2 { width: 171px; }");for(var o=document.getElementsByClassName("bigusername"),a=0,n=o.length;n>a;a++){var r=o[a].innerHTML;r===e&&r!==t&&o[a].parentNode.parentNode.parentNode.parentNode.parentNode.classList.add("op_post"),l.preferences.myPosts&&r===t&&o[a].parentNode.parentNode.parentNode.parentNode.parentNode.classList.add("my_post")}if(l.preferences.quotes)for(var i=document.getElementsByClassName("alt2"),a=0,n=i.length;n>a;a++){var s=i[a].getElementsByTagName("B");if(s&&s.length>0){var c=s[0].textContent;c===e&&c!==t&&i[a].classList.add("op_quote"),l.preferences.myPosts&&c===t&&i[a].classList.add("my_quote")}}var p=document.getElementById("threadtools"),u=p.parentNode,h=document.createElement("TD");h.className="vbmenu_control",h.innerHTML='<a href="/foro/search.php?do=process&searchthreadid='+d+"&searchuser="+escape(e)+'&exactname=1">Buscar posts del OP</a>',u.insertBefore(h,p)}function r(e){return decodeURIComponent((RegExp("[?|&]"+e+"="+"([^&;]+?)(&|#|;|$)").exec(location.search)||[undefined,""])[1].replace(/\+/g,"%20"))||null}function i(){var t;return(t=r("page"))?t:(t=document.getElementById("showthread_threadrate_form"))?t.page.value:(t=e("div.pagenav:first-child span strong")[0])?t.html():-1}function s(){var e;return(e=unsafeWindow.threadid)?e:(e=r("t"))?e:(e=document.getElementById("qr_threadid"))?e.t.value:null}var l=t({id:"HighlightOP",name:"Resaltar mensajes míos y del creador del hilo",author:"Electrosa",version:"1.0",description:"Resalta dentro de un hilo, los mensajes que has escrito tú y el creador del hilo, con un borde a la izquierda.",domain:["/showthread.php"],initialPreferences:{enabled:!0,opPostsColor:"#DC143C",myPosts:!1,myPostsColor:"#1E90FF",quotes:!0},preferences:{}});l.getPreferenceOptions=function(){var e=l.helper.createPreferenceOption;return[e({type:"text",mapsTo:"opPostsColor",caption:"Color de resaltado de los posts del creador del hilo"}),e({type:"checkbox",mapsTo:"myPosts",caption:"Resaltar también mis propios posts."}),e({type:"text",mapsTo:"myPostsColor",caption:"Color de resaltado de mis posts"}),e({type:"checkbox",mapsTo:"quotes",caption:"Resaltar también las citas."})]},l.normalStartCheck=function(){return!0};var d,c;l.onNormalStart=function(){if(d=s(),c=i(),1==c){var e=a(document.querySelector("#posts div.page"));sessionStorage["op_"+d]=e,n(e)}else d&&(sessionStorage["op_"+d]?n(sessionStorage["op_"+d]):o(d))}}(jQuery,SHURSCRIPT.moduleManager.createModule),function(e,t){"use strict";function o(t){e.ajax({url:"https://api.imgur.com/3/image",method:"POST",headers:{Authorization:"Client-ID e115ac41fea372d",Accept:"application/json"},data:{image:t.replace(/^data:image\/.*;base64,/,""),type:"base64"}}).done(function(e){d++,d==l&&n(),i("<br>[IMG]"+e.data.link+"[/IMG]")}).fail(function(e){s.helper.throw("Error al subir imagen a Imgur: "+t,e),d==l&&n()})}function a(t){t.stopPropagation(),t.preventDefault();var a=t.originalEvent.dataTransfer.files;console.log(a),l=a.length,d=0;var r;e.each(a,function(e,t){t.type.match("image.*")&&(r=new FileReader,r.onload=function(){return function(e){o(e.target.result)}}(t),r.readAsDataURL(t))}),r?(e("body").addClass("draguploading"),e("html").animate({scrollTop:e("#qrform").offset().top+"px"},800)):n()}function n(){e("body").removeClass("dragover draguploading")}function r(){return"/showthread.php"==s.helper.environment.page?unsafeWindow.vB_Editor.vB_Editor_QR:unsafeWindow.vB_Editor.vB_Editor_001}function i(e){r().insert_text(e)}var s=t({id:"ImageUploader",name:"Subir im&aacute;genes a Imgur",author:"xus0",version:"1.0",description:"Sube o arrastra im&aacute;genes desde tu equipo, y autom&aacute;ticamente se subir&aacute;n a Imgur y se postear&aacute;n en el hilo.",domain:["/showthread.php","/newthread.php","/newreply.php"],preferences:{}});s.onNormalStart=function(){GM_addStyle("body.dragover:before {color: white; font-size: 40px; text-align: center; padding-top: 150px;position: fixed; left: 0; top: 0; height: 100%; width: 100%; opacity: 0.7;background: url('http://s.imgur.com/images/imgur.gif') no-repeat scroll center 220px #121211;content: 'Suelta aquí las imágenes para subirlas a'};"),GM_addStyle("body.draguploading:before {content: 'Subiendo imágenes...'};"),n(),e("body").on("dragover",function(t){var o=t.originalEvent.dataTransfer.types;-1!=e.inArray("Files",o)&&-1==e.inArray("text/html",o)&&(console.log(t.originalEvent.dataTransfer),t.stopPropagation(),t.preventDefault(),e("body").addClass("dragover"),t.originalEvent.dataTransfer.dropEffect="copy")}),e("body").on("dragleave dragend",function(){n()}),e("body").on("drop",a)};var l,d}(jQuery,SHURSCRIPT.moduleManager.createModule);window.top===window&&(SHURSCRIPT.core.initializeEagerly(),jQuery(document).ready(SHURSCRIPT.core.initialize));